Below is a **Product Requirements Document (PRD)** for a Figma plugin that generates **email-safe, table-based HTML** from a selected frame, by turning **horizontal guides into exportable slices**, then packaging **`index.html` + `/images`** into a **ZIP**.

---

## PRD: Figma Plugin — Guide-Based Email Slicer → HTML + ZIP Export

### 1) Overview

A Figma plugin that converts a **selected Frame** into an **HTML email layout** built with **nested tables** and **image slices**. The plugin uses **horizontal guides** inside the frame to automatically generate **row slices**, exports those slices as images, and generates a **600px max-width responsive** HTML that scales images proportionally (email-client-safe). It then downloads a **ZIP** containing:

- `index.html`
- `/images/*` (all exported slices)

### 2) Goals

- Turn a Figma frame into a production-ready **legacy-compatible HTML email** (table-based).
- Use **horizontal guides** to define slice boundaries quickly.
- Support simple **multi-column image blocks** where each column scales proportionally.
- Allow link injection via **slice naming convention**.
- Generate a single ZIP export (no Node runtime; ZIP created in plugin environment via browser-compatible lib).

### 3) Non-Goals

- No support for semantic HTML, div-based layouts, flexbox/grid.
- No automatic text-to-HTML rendering (this is image-slice based).
- No advanced email features (dark mode swaps, VML buttons, etc.) unless added later.
- No support for vertical guides-based slicing (unless explicitly added later).

---

## 4) User Stories

1. **As a designer**, I want to select a frame and click “Generate slices” so the plugin creates exportable slices based on horizontal guides.
2. **As a marketer/dev**, I want to click “Export HTML” so I get a ZIP with `index.html` and images ready to upload/send.
3. **As a user**, I want the plugin UI to always reflect my current selection, so buttons only enable when a valid frame is selected.
4. **As a user**, I want to clear generated guides/slices so I can re-run slicing without manual cleanup.

---

## 5) Functional Requirements

### 5.1 Selection & Live State

- Plugin must **continuously listen** to selection changes (not only on UI open).
- Determine when the current selection is valid:
  - Exactly **one node selected**
  - Node type must be **FRAME** (or optionally COMPONENT/INSTANCE if you choose)

- UI buttons must enable/disable based on selection validity:
  - When no valid selection: show a “Select a frame to begin” state; disable action buttons.

**Events**

- Use `figma.on("selectionchange", ...)` to update UI state.

---

### 5.2 Guide Parsing → Slice Generation

**Input**

- A selected frame.
- Horizontal guides associated to that frame (or contained guides system).

**Behavior**

- Read all **horizontal guides** (Y positions) relevant to the selected frame.
- Sort guides ascending.
- Derive slice rectangles:
  - Top boundary: frame top (0) OR first guide position (depending on spec)
  - Slice boundaries occur between consecutive guide lines.
  - Last slice ends at frame bottom.

- For each slice:
  - Create a rectangle node (or a “slice marker” layer) aligned to that region.
  - Name it deterministically (e.g., `slice-001`, `slice-002`, etc.) unless guide labels exist.
  - The slice marker should be:
    - Locked (optional)
    - Placed in a dedicated group like `__SLICES__`
    - Non-visible fill/stroke (or very light) to avoid design disruption

**Clear Slices**

- “Clear slices” should remove all slice markers previously generated by the plugin (ideally by:
  - Group name, plugin data, or a prefix-based naming scheme).

**Clear Guides**

- “Clear guides” removes horizontal guides (if plugin created them) OR all guides in the frame (define which; recommended: only those with plugin metadata).

**Metadata**

- Each generated slice should store plugin data:
  - `pluginData: { kind: "email-slice", index, y0, y1 }`
  - This makes clearing and re-export deterministic.

---

### 5.3 Export Image Assets (via Figma API)

**Asset Source**

- Export each slice region as a PNG (or JPG option later).
- Export method must produce consistent pixel output:
  - Use `exportAsync` on a node when possible.
  - If exporting exact regions is needed: create a temporary node representing the slice or use frame cloning + masking strategy.

**Scaling**

- Export at **1x** by default (add 2x later optionally).
- Must preserve crisp edges; avoid fractional pixel boundaries:
  - Guide positions should be snapped to pixels when exporting (rounding rules defined below).

**File Naming**

- Default: `slice-001.png`, `slice-002.png`, ...
- If slice layer name exists, use a sanitized version:
  - `Hero (https://example.com)` → `hero.png`
  - Also store the original name for link parsing.

---

### 5.4 HTML Generation (Email-Compatible)

**Output**

- Generate `index.html` containing:
  - A centered wrapper table
  - 600px max width layout
  - Images sized with `width` attribute and inline CSS for responsiveness

**Base Layout Requirements**

- Overall email container:
  - `table` with `width="100%"` and `bgcolor` optional
  - Inner table with `width="600"` aligned center
  - Style: `margin:0 auto;` (where supported)

- Each slice becomes a row:
  - `<tr><td> ... </td></tr>`

**Image Responsiveness**

- Each image should render:
  - `width="600"` (or computed column width)
  - `style="display:block; width:100%; max-width:600px; height:auto; border:0;"`
  - Include `alt=""` default unless you add alt parsing.

**Multi-Column Support**

- If a slice is subdivided into multiple columns (your prior behavior):
  - Detect columns inside the slice area (see detection options below)
  - Output nested table with multiple `<td>` columns and images for each column
  - Column widths:
    - Compute proportional widths based on original slice column widths
    - Ensure sum = 600 (or the row width)

  - Each column image:
    - `width="<computed>"` and `style="display:block; width:100%; max-width:<computed>px; height:auto;"`

**Column Detection (choose one deterministic approach)**

- **Option A (recommended for speed):** within each slice region, look for top-level child frames/rectangles marked as “column” (by naming convention `col-*` or plugin data).
- **Option B:** parse direct children of the selected frame whose bounding boxes fall within slice Y-range, then group by X positions into columns.

(Your PRD can state Option A as MVP and keep B as future.)

---

### 5.5 Link Injection via Slice Naming Convention

**Rule**

- If a slice name ends with parentheses, interpret the content as a URL and wrap the image with `<a>`.

Example:

- Layer name: `Hero (https://example.com)`
- Output:
  - `<a href="https://example.com" target="_blank"><img ... /></a>`

**Parsing Rules**

- Detect final parentheses group: `... ( ... )` at end of string.
- Extract and trim.
- Validate basic URL format:
  - Starts with `http://` or `https://`
  - If invalid, ignore link behavior (still export image).

---

### 5.6 ZIP Packaging & Download

**Requirement**

- Export must produce a downloadable ZIP containing:
  - `/index.html`
  - `/images/<slice files>`

**Constraints**

- Must use a **browser-compatible ZIP library** (runs inside plugin environment, not Node).
  - Example options: JSZip (commonly used) or equivalent.

**Download Mechanism**

- The plugin should trigger file save for the ZIP in Figma plugin environment:
  - Use UI to create blob and `postMessage` / `figma.ui.postMessage` flow.
  - UI handles `URL.createObjectURL(blob)` and triggers download.

---

## 6) UI / UX Requirements

### 6.1 Layout

- Minimal UI panel with:
  - Status area (selection state)
  - Buttons:
    - Row 1 (full width): **Generate slices**
    - Row 2 (full width): **Export HTML**
    - Row 3 (two buttons 50/50): **Clear guides** | **Clear slices**

- Buttons disabled if no valid frame selected.

### 6.2 States

- **Idle / No selection**
  - Text: “Select a frame to enable actions.”
  - All buttons disabled.

- **Valid frame selected**
  - Show frame name.
  - Enable Generate / Export / Clear buttons.

- **Generating slices**
  - Show loading indicator; disable buttons until done.

- **Exporting**
  - Progress text (optional): “Exporting 3/12 slices…”
  - Disable buttons until ZIP ready.

- **Success**
  - “Export complete” + optional file name shown.

- **Error**
  - Display reason (e.g., “No horizontal guides found.”)

---

## 7) Edge Cases & Rules

### 7.1 No Guides Found

- If no horizontal guides exist:
  - Either block generation with error “No horizontal guides found”
  - Or generate a single slice for the full frame (pick one; MVP suggestion: error to avoid surprises)

### 7.2 Guides Outside Frame Bounds

- Ignore guides above 0 or below frame height.
- Deduplicate guides with the same rounded position.

### 7.3 Pixel Rounding

- When converting guide positions to pixel slice boundaries:
  - Round to nearest integer pixel.
  - Ensure no gaps/overlaps:
    - `y0 = round(prev)`
    - `y1 = round(next)`
    - enforce `y1 > y0`

### 7.4 Export Limits

- Handle large frames (many slices):
  - Provide warning if slice count > N (e.g., 100)
  - Ensure memory doesn’t explode when zipping (streaming later; MVP can be in-memory)

---

## 8) Technical Notes (Implementation-Oriented)

### 8.1 Data Flow

1. UI loads → shows “Select a frame”
2. `selectionchange` → validates selection → enables actions
3. Generate slices:
   - read guides → compute slice rects → create slice marker layers with plugin metadata

4. Export:
   - resolve slice list (from markers or recalculated)
   - export PNG bytes for each slice
   - generate HTML string referencing `images/<name>.png`
   - package HTML + images into ZIP
   - trigger download

### 8.2 Naming & Metadata Strategy

- Use `setPluginData` on slice markers to identify them reliably.
- Use stable prefix for group/layers: `__EMAIL_SLICES__`.

---

## 9) Acceptance Criteria

### Generate Slices

- When a valid frame is selected and it contains horizontal guides:
  - Clicking **Generate slices** creates slice marker layers covering the frame, split at each guide.
  - Slice markers are grouped under `__EMAIL_SLICES__`.
  - Re-clicking Generate slices does not create duplicates (either clears previous slices first, or regenerates in-place).

### Export

- When **Export HTML** is clicked:
  - Plugin exports one image per slice (or per detected column within a slice, if applicable).
  - Plugin generates `index.html` containing table-based layout compatible with legacy email clients.
  - Images are output with `width` attribute and inline style to enforce:
    - `width:100%`
    - `max-width:600px` (default)
    - proportional scaling for multi-column images

  - If slice name ends with `(URL)` then HTML wraps that image in an anchor tag using that URL.
  - Plugin downloads a ZIP with:
    - `index.html`
    - `images/` folder with all slice images

### Clear Actions

- **Clear slices** removes all plugin-generated slice markers (`kind=email-slice`).
- **Clear guides** removes plugin-created guides (or all guides in the frame, depending on chosen scope), without breaking the original content.

### UI Reactivity

- If selection changes while plugin UI is open:
  - UI updates within 250ms–500ms.
  - Buttons enable/disable correctly based on whether a frame is selected.

---

## 10) Future Enhancements (Optional)

- Vertical guide slicing + grid slicing.
- Export retina (`2x`) images + appropriate HTML scaling.
- Background color support + spacer rows.
- Text layer parsing into HTML (hybrid).
- Per-slice export settings via naming tokens (e.g., `(link=...)`, `(alt=...)`, `(bg=...)`).

---

If you want, I can also turn this PRD into:

- a single Jira story with subtasks + estimates, or
- a technical design doc with the message-passing flow between `code.ts` and `ui.html`, plus a suggested slice-export strategy that avoids needing masks.
